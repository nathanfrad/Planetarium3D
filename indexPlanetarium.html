<!DOCTYPE html>
<html lang="en">
<head>
    <title>Planetarium</title>
    <meta charset="utf-8">
    <meta name="viewport" content="user-scalable=no, initial-scale=1">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.12/css/all.css"
          integrity="sha384-G0fIWCsCzJIMAVNQPfjH08cyYaUtMwjJwqiRKxxE/rx96Uroj1BtIQ6MLJuheaO9" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="style/css.css">

</head>
<body>

<script src="build/three.js"></script>
<!-- <script src="js/controls/DeviceOrientationControls.js"></script> -->
<script src="js/controls/OrbitControls.js"></script> <!-- rotation autour du target -->
<script src="js/Detector.js"></script>

<script src="js/renderers/Projector.js"></script>
<script src="js/renderers/CanvasRenderer.js"></script>
<script src="js/libs/stats.min.js"></script>
<script src="js/libs/tween.min.js"></script> <!--  changement d'orbite  smooth -->

<script src='threex.planets/threex.planets.js'></script>
<script src='threex.planets/threex.atmospherematerial.js'></script>

<script src='jsperso/3DPlanet.js'></script>
<script src='jsperso/NavBarBottom.js'></script>
<script src='jsperso/search.js'></script>

<div id="btn">

    <!--<div id="btn-photo">


        <button>
             Nouvelle photo <i class="fas fa-camera"></i>
         </button>
         <button>
             Gallerie photo <i class="fas fa-images"></i>
         </button>
     </div>-->

    <div id="btn-navigation">

    </div>

</div>


<div id="myModal" class="modal">
    <!-- Modal content -->
    <div class="modal-content">
        <div class="modal-header">
            <span class="close">&times;</span>
            <h3> <i class="fas fa-search fa-1x" aria-hidden="true"></i> <input id="search" type="search" placeholder="Recherche" />
            </h3>
        </div>

        <div id="listPlanete">

            <h3> Plan√®tes </h3>
            <ul>
                <li class="">
                    <i class="fas fa-globe"></i>
                    <a>Moon</a>
                    <i class="fas fa-info"></i>
                    <i class="fas fa-space-shuttle" data-fa-transform="rotate-100" onclick='switchValue("Moon");'></i>
                </li>
                <li class="">
                    <i class="fas fa-globe"></i>
                    <a>Saturn</a>
                    <i class="fas fa-info"></i>
                    <i class="fas fa-space-shuttle" data-fa-transform="rotate-100" onclick='switchValue("Saturn");'></i>
                </li>
                <li class="">
                    <i class="fas fa-globe"></i>
                    <a>Uranus</a>
                    <i class="fas fa-info"></i>
                    <i class="fas fa-space-shuttle" data-fa-transform="rotate-100" onclick='switchValue("Uranus");'></i>
                </li>
                <li class="">
                    <i class="fas fa-globe"></i>
                    <a>Jupiter</a>
                    <i class="fas fa-info"></i>
                    <i class="fas fa-space-shuttle" data-fa-transform="rotate-100"
                       onclick='switchValue("Jupiter");'></i>
                </li>
                <li class="">
                    <i class="fas fa-globe"></i>
                    <a>Mars</a>
                    <i class="fas fa-info"></i>
                    <i class="fas fa-space-shuttle" data-fa-transform="rotate-100" onclick='switchValue("Mars");'></i>
                </li>
                <li class="">
                    <i class="fas fa-globe"></i>
                    <a>Mercury</a>
                    <i class="fas fa-info"></i>
                    <i class="fas fa-space-shuttle" data-fa-transform="rotate-100"
                       onclick='switchValue("Mercury");'></i>
                </li>
                <li class="">
                    <i class="fas fa-globe"></i>
                    <a>Venus</a>
                    <i class="fas fa-info"></i>
                    <i class="fas fa-space-shuttle" data-fa-transform="rotate-100" onclick='switchValue("Venus");'></i>
                </li>
                <li class="">
                    <i class="fas fa-globe"></i>
                    <a>Neptune</a>
                    <i class="fas fa-info"></i>
                    <i class="fas fa-space-shuttle" data-fa-transform="rotate-100"
                       onclick='switchValue("Neptune");'></i>
                </li>

            </ul>

        </div>

    </div>
</div>

<script>

    var camera, scene, renderer;
    var mouse;
    var objectsPlanets = [];
    var onRenderFcts = [];

    var controls;

    init();
    animate();

    document.getElementById("btnAgenda").addEventListener('click', AddInputAgenda, false);


    document.getElementById("btn-navigation").addEventListener('mousedown', mouseDown, false);
    document.getElementById("btn-navigation").addEventListener('mouseup', mouseUp, false);

    function mouseDown(event) {
        event.target.style.color = "white";
    }

    function mouseUp(event) {
        event.target.style.color = "#D4C3B5";
    }

    // Get the modal
    var modal = document.getElementById('myModal');

    // Get the button that opens the modal
    var btnRecherche = document.getElementById("btnRecherche");


    // Get the <span> element that closes the modal
    var span = document.getElementsByClassName("close")[0];

    // When the user clicks the button, open the modal
    btnRecherche.onclick = function () {
        modal.style.display = "block";
    }


    // When the user clicks on <span> (x), close the modal
    span.onclick = function () {
        modal.style.display = "none";
    }


    var geometry = new THREE.CircleGeometry(80, 50);
    var material = new THREE.LineBasicMaterial({color: 0xfff});
    var circle = new THREE.LineLoop(geometry, material);
    geometry.vertices.shift();

    circle.rotation.x = Math.PI / 2;
    circle.position.z = 0
    circle.position.x = 0
    scene.add(circle);


    /* // test de codepen

     var  canvas = document.createElement('canvas');
     var context = canvas.getContext('2d');
    var  textHeight = 10;
    var  actualFontSize = 0.12;

     function addText(position, text) {
         // 2d duty
         metrics = context.measureText(text);
         var textWidth = metrics.width;

         canvas.width = textWidth;
         canvas.height = textHeight;
         context.font = "normal " + textHeight + "px Arial";
         context.textAlign = "center";
         context.textBaseline = "middle";
         context.fillStyle = "#ff0000";
         context.fillText(text, textWidth / 2, textHeight / 2);

         var texture = new THREE.Texture(canvas);
         texture.needsUpdate = true ;
         var material = new THREE.SpriteMaterial({ map: texture, useScreenCoordinates: false });
         var sprite = new THREE.Sprite( material );

         var textObject = new THREE.Object3D();
         // var sprite = new THREE.Sprite(texture);
         textObject.textHeight = actualFontSize;
         textObject.textWidth = (textWidth / textHeight) * textObject.textHeight;
         sprite.scale.set(textWidth / textHeight * actualFontSize, actualFontSize, 1);


         textObject.add(sprite);
         return textObject;
     }

     text = addText(new Array(0, 9), "it fucking works!!");
     scene.add( text );*/

    // create a canvas element
    /*var canvas1 = document.createElement('canvas');
     var context1 = canvas1.getContext('2d');
     canvas1.width= 50000 ;
     canvas1.height = 50000;
     canvas1.style.width= "50000px" ;
     canvas1.style.height = "50000px";

     var x = canvas1.width / 2;
     var y = canvas1.height / 2;


     context1.font = "20px Calibri";
     context1.textAlign = 'center';
     context1.fillStyle = "rgba(255,0,0,1)";
     context1.fillText('Nord',x,y);



     // canvas contents will be used for a texture
     var texture1 = new THREE.Texture(canvas1)
     texture1.needsUpdate = true;

     var material1 = new THREE.MeshBasicMaterial( {map: texture1, side:THREE.DoubleSide } );
     material1.transparent = true;
     var mesh1 = new THREE.Mesh(
         new THREE.PlaneGeometry(canvas1.width, canvas1.height),
         material1
     );

     console.log( " canvas1.height :" +canvas1.height )
     console.log( " canvas1.width :" +canvas1.width )
     mesh1.position.set(0,0,-80);
     scene.add( mesh1 );*/


    var accueil
    var earthExist = false;

    function init() {

        //rendu
        renderer = new THREE.WebGLRenderer({antialias: true});
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        addBtnAccueil();

        accueil = true;


        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 1000);
        camera.position.set(0.1, 0, 0);

        scene = new THREE.Scene();

        //controls = new THREE.DeviceOrientationControls( camera )

        controls = new THREE.OrbitControls(camera, renderer.domElement );
        //controls.autoRotate = true ;
        controls.autoRotateSpeed = 0.07;
        controls.target.z = 0
        controls.enablePan = false;
        controls.enableZoom = true;
        controls.enableDamping = true;
        controls.minPolarAngle = 0.8;
        controls.maxPolarAngle = Math.PI;
        controls.dampingFactor = 0.07;
        controls.rotateSpeed = 0.07;


        var geometry = new THREE.SphereBufferGeometry(500, 60, 40);
        // invert the geometry on the x-axis so that all of the faces point inward
        geometry.scale(-1, 1, 1);

        var material = new THREE.MeshBasicMaterial({
            //color: 0x1C1C1C
            //map: new THREE.TextureLoader().load( 'textures/maison_bg.jpg' )
            map: new THREE.TextureLoader().load('textures/stars_bg.png')
        });

        var mesh = new THREE.Mesh(geometry, material);
        scene.add(mesh);


        creaPlanets();

        //light
        light();

        //The X axis is red. The Y axis is green. The Z axis is blue.
        scene.add(new THREE.AxesHelper(8000));

        // click
        raycaster = new THREE.Raycaster();
        mouse = new THREE.Vector2();


        //click
        document.addEventListener('mousedown', onDocumentMouseDown, false);
        document.addEventListener('touchstart', onDocumentTouchStart, false);

        window.addEventListener('resize', onWindowResize, false);

    }


    function light() {
        var light = new THREE.AmbientLight(0x888888)
        scene.add(light)

        var light = new THREE.DirectionalLight(0xffffff, 1)
        light.position.set(5, 5, 5)
        scene.add(light)
        light.castShadow = true
        light.shadow.camera.near = 0.01
        light.shadow.camera.far = 15
        light.shadow.camera.fov = 45

        light.shadow.camera.left = -1
        light.shadow.camera.right = 1
        light.shadow.camera.top = 1
        light.shadow.camera.bottom = -1

        light.shadow.bias = 0.001

        light.shadow.mapSize.width = 1024
        light.shadow.mapSize.heigh = 1024

        scene.add(light)
    }


    function animate() {

        window.requestAnimationFrame(animate);

        for (var i = 0; i < objectsPlanets.length; i++) {
            objectsPlanets[i].rotation.y += 0.0004;
            //objectsPlanets[ i ].rotation.x += 0.0004;
            //earthMesh.rotation.y += 1/32 * delta;
        }


        /* setTimeout(function() {
             /*var cameraDirectionVector = new THREE.Vector3(0, 0, -1);
             cameraDirectionVector.applyEuler(camera.rotation, camera.eulerOrder);

             console.log(" cameraDirectionVector " + cameraDirectionVector.x) ;

             var ray = new THREE.Raycaster( camera.position, cameraDirectionVector );
             var collisionResults = ray.intersectObjects( objectsPlanets  );
             console.log( " collisionResults.length : " + collisionResults.length)
             if ( collisionResults.length > 0 )
             {
                 console.log( " collisionResults[0].distance : " + collisionResults[0].distance )
                 if (collisionResults[0].distance < 0.5) {
                     console.log("bim bam boumm collision ! ")
                 }
             }*/
        /*
                        },2000);*/
        //detectCollision();


        renderer.render(scene, camera);
        controls.update();
        TWEEN.update();
    }


    function onWindowResize() {

        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function onDocumentTouchStart(event) {

        //event.preventDefault();
        event.clientX = event.touches[0].clientX;
        event.clientY = event.touches[0].clientY;
        onDocumentMouseDown(event);
    }

    function onDocumentMouseDown(event) {

        //event.preventDefault();
        mouse.x = (event.clientX / renderer.domElement.clientWidth) * 2 - 1;
        mouse.y = -(event.clientY / renderer.domElement.clientHeight) * 2 + 1;
        raycaster.setFromCamera(mouse, camera);
        var intersects = raycaster.intersectObjects(objectsPlanets, true);

        if (intersects.length > 0) {

            var namePlanet = intersects[0].object.parent.name

            switchValue(namePlanet);

            //getDistance(namePlanet)

            // collision(); // probleme il faudra que collision soit actif tant que la camera bouge :  A REVOIR

        }

        /* if (intersects.length > 0) {

             if (intersectParents === null) {
                 console.log( "et merde c'est null ")
             }
             console.log(  " intersects[ 0 ].object : " + intersects[ 0 ].object )
             console.log(  " intersects[ 0 ].object.parent : " + intersects[ 0 ].object.parent)
             console.log(  " intersects[ 0 ].object.parent.parent : " + intersects[ 0 ].object.parent.parent )
         }


         if (intersects.length > 0) {

             console.log(  " intersects[ 0 ].object : " + intersects[ 0 ].object.position.x )
             console.log(  " intersects[ 0 ].object.parent : " + intersects[ 0 ].object.parent.position.z )
             console.log(  " intersects[ 0 ].object.parent.parent : " + intersects[ 0 ].object.parent.parent.position.x  )
         }*/

    }

    var currentObj = null


    function switchValue(choix) {

        // Get the button that opens the modal

        if (choix == "Back") {

            console.log(" init : acceuil in back :" + accueil)

            earthExist = false;


            if (currentObj != null) {

                var objX = currentObj.position.x
                var objZ = currentObj.position.z;

                console.log(" objX :" + objX)
                console.log(" objZ :" + objZ)

                if (objX > 0) {
                    var directX = -0.1;
                } else {
                    var directX = 0.1;
                }

                if (objZ > 0) {
                    var directZ = -0.1;
                } else {
                    var directZ = 0.1;
                }

                console.log(" directX :" + directX)
                console.log(" directZ :" + directZ)

                var obj = scene.getObjectByName("Earth");

                unfocusTarget();

                setTimeout(function () {
                    unfocusZoom(directX, directZ)
                }, 500);
                console.log(choix + " : Retour a la casa !  ")

                if (camera.position.x < 0.15 || camera.position.z < 0.15) {
                    setTimeout(function () {
                        scene.remove(obj)

                        for (var i = 0; i < objectsPlanets.length; i++) {
                            console.log(" Avant affiche toute les planetes : " + objectsPlanets[i].name)

                            if (objectsPlanets[i].name == "Earth") {
                                var obj = scene.getObjectByName(objectsPlanets[i].name);
                                scene.remove(objectsPlanets)
                                console.log(" je supprime la planete : " + objectsPlanets[i].name)
                            }
                        }

                        /* for ( var i = 0; i < objectsPlanets.length  ; i++ ) {
                             console.log(" affiche toute les planetes : " + objectsPlanets[i].name)
                         }*/

                        for (var i = 0; i < objectsPlanets.length; i++) {
                            console.log(" Apres affiche toute les planetes : " + objectsPlanets[i].name)
                        }
                    }, 3000);
                }

                controls.autoRotate = false;

                if (!accueil) {
                    console.log(" addBtnAccueilBack :" + accueil)
                    addBtnAccueilBack()
                    deleteBtnPhoto();
                    accueil = true;

                }


            }

        } else {

            console.log("Direction la planete " + choix + " ! ")
            var obj = scene.getObjectByName(choix);

            currentObj = obj; // pour gerer la direction de la camera quand on revient sur terre

            // test pour savoir si on clique sur la planete sur laquelle nous sommes deja
            var controlX = controls.target.x;
            var controlZ = controls.target.z;

            var objX = obj.position.x
            var objZ = obj.position.z;


            if (controlX !== objX || controlZ !== objZ) {
                focusTarget(obj);


                setTimeout(function () {
                    focusZoom(obj)

                    if (!earthExist) {
                        creaEarth();
                        console.log("1 earthExist :" + earthExist)
                        earthExist = true
                        console.log("2 earthExist :" + earthExist)
                    }


                }, 500);

                controls.autoRotate = true;

                if (accueil) {
                    addBtnPlanet()
                    addBtnPhoto()
                    accueil = false;

                }

            } else {

                console.log("je bouge pas car je suis deja sur la planete en question !!! ")

            }

        }


        // fermer le modal quand on appui sur la navette
        if (modal.style.display = "block") {
            modal.style.display = "none"
        }

    }


    function focusZoom(obj) {
        focused = true;

        var target = {
            x: 0.05 * camera.position.x + 0.7 * obj.position.x,
            //y: 0.05 * camera.position.y + 0.2 * obj.position.y,
            z: 0.05 * camera.position.z + 0.7 * obj.position.z
        };

        new TWEEN.Tween(camera.position)
            .to(target, 2000)
            .easing(TWEEN.Easing.Quadratic.InOut)
            .start();

    }

    function focusTarget(obj) {

        new TWEEN.Tween(controls.target).to({x: obj.position.x, y: obj.position.y, z: obj.position.z}, 2500)
            .easing(TWEEN.Easing.Quadratic.InOut).start();

    }


    function unfocusZoom(directZ, directX) {

        //controls = new THREE.VRControls(camera);
        new TWEEN.Tween(camera.position).to({x: directX, y: 0, z: directZ}, 2500)
            .easing(TWEEN.Easing.Quadratic.InOut).start();
    }

    function unfocusTarget() {
        new TWEEN.Tween(controls.target).to({x: 0, y: 0, z: 0}, 2000)
            .easing(TWEEN.Easing.Quadratic.InOut).start();
    }

</script>
</body>
</html>
